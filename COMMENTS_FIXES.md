# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º arq_worker –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–û—à–∏–±–∫–∏ –≤ arq_worker (VK API)**

**–ü—Ä–æ–±–ª–µ–º–∞**:

```
VK API –æ—à–∏–±–∫–∞ –≤ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: One of the parameters specified was missing or invalid: sort should be asc, desc or smart (–∫–æ–¥: 100)
```

**–ü—Ä–∏—á–∏–Ω–∞**:
–í –º–µ—Ç–æ–¥–µ `get_all_post_comments` –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä `sort` –≤ –≤—ã–∑–æ–≤ `get_post_comments`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: ‚úÖ

- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `sort` –≤ –≤—ã–∑–æ–≤ `get_post_comments` –≤ –º–µ—Ç–æ–¥–µ `get_all_post_comments`

### 2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–∏–º–∏—Ç–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (10 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)**

**–ü—Ä–æ–±–ª–µ–º–∞**:
–û—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ 10 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.

**–ü—Ä–∏—á–∏–Ω—ã**:

1. **FastAPI –Ω–µ –º–æ–≥ –∏–∑–≤–ª–µ—á—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ query string** –¥–ª—è `CommentSearchParams = Depends()`
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏** –º–µ–∂–¥—É `CommentSearchParams` –∏ `PaginationParams`
3. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤** –º–µ–∂–¥—É frontend (`skip`/`limit`) –∏ backend (`page`/`size`)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ‚úÖ

- –ó–∞–º–µ–Ω–∏–ª `CommentSearchParams = Depends()` –Ω–∞ —è–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
- –£–±—Ä–∞–ª –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `skip`/`limit` –∏–∑ `CommentSearchParams`
- –ò—Å–ø—Ä–∞–≤–∏–ª —Ç–∏–ø—ã –≤ frontend –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è backend API
- –û–±–Ω–æ–≤–∏–ª —Ö—É–∫–∏ React Query –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º**

**–ü—Ä–æ–±–ª–µ–º–∞**:
–í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ‚úÖ

- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –º–µ—Ç–æ–¥ `_find_keywords_in_text`
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –º–µ—Ç–æ–¥ `filter_comments`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞

## üõ†Ô∏è –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Backend

1. **backend/app/services/vkbottle_service.py**

   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `sort` –≤ –º–µ—Ç–æ–¥–µ `get_all_post_comments`

2. **backend/app/api/v1/parser.py**

   - –ó–∞–º–µ–Ω–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `CommentSearchParams = Depends()` –Ω–∞ —è–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ API

3. **backend/app/schemas/vk_comment.py**

   - –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `skip`/`limit` –∏–∑ `CommentSearchParams`

4. **backend/app/services/parser_service.py**

   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

5. **backend/app/api/v1/comments.py**
   - –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π endpoint `/comments/`

### Frontend

1. **frontend/lib/api.ts**

   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (`/parser/comments`)

2. **frontend/types/api.ts**

   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (`page`/`size` –≤–º–µ—Å—Ç–æ `skip`/`limit`)
   - –û–±–Ω–æ–≤–ª–µ–Ω `PaginatedResponse`
   - –£–±—Ä–∞–Ω—ã `skip`/`limit` –∏–∑ `CommentSearchParams`

3. **frontend/entities/comment/types.ts**

   - –£–±—Ä–∞–Ω—ã `skip`/`limit` –∏–∑ `CommentSearchParams`

4. **frontend/features/comments/hooks/use-comments.ts**

   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ `useInfiniteComments`

5. **frontend/hooks/use-comments.ts**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ `useInfiniteComments`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test_comments_api.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
python test_comments_api.py
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –≥—Ä—É–ø–ø–µ
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
- ‚úÖ –õ–æ–≥–∏ arq_worker –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **arq_worker**: –û—à–∏–±–∫–∏ VK API —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `sort` –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å
2. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: –î–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ 10)
3. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**: –î–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `page` –∏ `size`
4. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –î–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
5. **–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫**: –î–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤**

–î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ arq_worker:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker logs -f fullstack_prod_arq_worker

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
docker logs fullstack_prod_arq_worker | grep -i error
```

### 2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# –í backend/app/core/config.py
log_level: str = Field(default="INFO", alias="LOG_LEVEL")
```

### 3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è API –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:

```python
# –í backend/app/services/parser_service.py
@cache(expire=300)  # 5 –º–∏–Ω—É—Ç
async def filter_comments(...)
```

### 4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤**

–î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ:

- –ü–∞–≥–∏–Ω–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é JOIN –∑–∞–ø—Ä–æ—Å–æ–≤

### 5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

–°–æ–∑–¥–∞–π—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```python
# –ü—Ä–∏–º–µ—Ä –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
async def load_test_comments_api():
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤
    pass
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. **–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**:

   ```bash
   docker-compose -f docker-compose.prod.yml build
   docker-compose -f docker-compose.prod.yml up -d
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**:

   ```bash
   docker logs fullstack_prod_arq_worker
   docker logs fullstack_prod_backend
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã**:

   ```bash
   python test_comments_api.py
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ frontend**:
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–≥–∏–Ω–∞—Ü–∏—é
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

1. **–ú–µ—Ç—Ä–∏–∫–∏ arq_worker**:

   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–¥–∞—á
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
   - –û—à–∏–±–∫–∏ VK API

2. **–ú–µ—Ç—Ä–∏–∫–∏ API**:

   - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û—à–∏–±–∫–∏

3. **–ê–ª–µ—Ä—Ç—ã**:
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ arq_worker
   - –í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
   - –û—à–∏–±–∫–∏ VK API

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
**–î–∞—Ç–∞**: $(date)
**–í–µ—Ä—Å–∏—è**: 1.0.0
