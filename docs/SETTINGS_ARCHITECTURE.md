# 🎛️ Архитектура системы настроек

## Обзор

Система настроек VK Comments Parser предоставляет централизованное управление конфигурацией приложения через веб-интерфейс. Архитектура построена с учетом принципов безопасности, масштабируемости и удобства использования.

## 📊 Анализ текущей архитектуры

### Основные модули проекта:

**Backend (FastAPI + SQLAlchemy + PostgreSQL + Redis):**

- **API модули**: `groups`, `keywords`, `comments`, `parser`, `monitoring`, `stats`, `morphological`, `settings`
- **Модели данных**: `VKGroup`, `Keyword`, `VKComment`, `VKPost`, `User`, `CommentKeywordMatch`
- **Конфигурация**: `DatabaseSettings`, `VKSettings`, `MonitoringSettings`, `LoggingSettings`, `UISettings`
- **Сервисы**: планировщик мониторинга, парсер VK, морфологический анализ, управление настройками
- **Workers**: Arq для фоновых задач

**Frontend (Next.js 14 + TypeScript + TailwindCSS):**

- **Страницы**: Dashboard, Groups, Keywords, Comments, Parser, Monitoring, **Settings**
- **Store**: Zustand для управления состоянием приложения
- **Компоненты**: UI компоненты, layout (sidebar, header)
- **Навигация**: ссылка на Settings в sidebar

### Ключевые настройки проекта:

1. **VK API**: токен, версия API, лимиты запросов
2. **Мониторинг**: интервалы, приоритеты групп, автозапуск
3. **База данных**: подключение, пулы соединений
4. **Логирование**: уровни, форматы
5. **UI настройки**: тема, автообновление, уведомления

## 🏗️ Архитектура системы настроек

### Backend архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   FastAPI App   │───▶│  Settings API    │───▶│ SettingsService │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Pydantic      │    │   Environment    │    │   Validation    │
│   Schemas       │    │   Variables      │    │   & Caching     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

#### Компоненты:

1. **API Layer** (`backend/app/api/v1/settings.py`)

   - RESTful endpoints для CRUD операций с настройками
   - Валидация входных данных через Pydantic
   - Обработка ошибок и логирование

2. **Service Layer** (`backend/app/services/settings_service.py`)

   - Бизнес-логика управления настройками
   - Кеширование настроек (TTL: 5 минут)
   - Валидация и применение настроек
   - Health checks для компонентов системы

3. **Configuration Layer** (`backend/app/core/config.py`)
   - Pydantic модели для типизированной конфигурации
   - Загрузка из environment variables
   - Валидация на уровне схем

### Frontend архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Settings      │───▶│  React Query     │───▶│   API Client    │
│   Page          │    │   Hooks          │    │   (Axios)       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   UI Components │    │   TypeScript     │    │   State         │
│   (Tabs, Forms) │    │   Types          │    │   Management    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

#### Компоненты:

1. **Page Layer** (`frontend/app/settings/page.tsx`)

   - Главная страница настроек с layout
   - Suspense для загрузочных состояний
   - Композиция компонентов

2. **Feature Layer** (`frontend/features/settings/`)

   - Модульная организация по функциональности
   - Переиспользуемые UI компоненты
   - Логика управления состоянием форм

3. **API Layer** (`frontend/lib/api.ts`, `frontend/hooks/use-settings.ts`)
   - Типизированные API вызовы
   - React Query для кеширования и синхронизации
   - Обработка ошибок и уведомления

## 🔧 Технический стек

### Backend

- **FastAPI** - современный веб-фреймворк с автоматической документацией
- **Pydantic** - валидация данных и сериализация
- **SQLAlchemy** - ORM для работы с базой данных
- **Redis** - кеширование и фоновые задачи
- **Structlog** - структурированное логирование

### Frontend

- **Next.js 14** - React фреймворк с App Router
- **TypeScript** - типизация для безопасности кода
- **TailwindCSS** - utility-first CSS фреймворк
- **React Query** - управление состоянием сервера
- **Zustand** - легковесное управление состоянием
- **Radix UI** - доступные UI примитивы

## 📋 Функциональность

### Управляемые настройки

#### VK API Settings

- **Access Token** - токен доступа к API ВКонтакте
- **API Version** - версия API (рекомендуется 5.131)
- **Requests per Second** - лимит запросов (1-20)

#### Monitoring Settings

- **Scheduler Interval** - интервал планировщика (60-3600 сек)
- **Max Concurrent Groups** - максимум групп одновременно (1-50)
- **Group Delay** - задержка между группами (0-10 сек)
- **Auto Start Scheduler** - автозапуск планировщика

#### Database Settings

- **Pool Size** - размер пула соединений (5-50)
- **Max Overflow** - максимальное переполнение (10-100)
- **Pool Recycle** - пересоздание соединений (300-7200 сек)

#### Logging Settings

- **Level** - уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- **Format** - формат логов (JSON, TEXT)
- **Include Timestamp** - включение временных меток

#### UI Settings

- **Theme** - тема интерфейса (light, dark, system)
- **Auto Refresh** - автообновление данных
- **Refresh Interval** - интервал обновления (10-300 сек)
- **Items per Page** - элементов на странице (10-100)
- **Show Notifications** - показ уведомлений

### API Endpoints

```
GET    /api/v1/settings/          - Получить текущие настройки
PUT    /api/v1/settings/          - Обновить настройки
POST   /api/v1/settings/reset     - Сбросить к значениям по умолчанию
GET    /api/v1/settings/health    - Проверить состояние системы
```

## 🔒 Безопасность

### Принципы безопасности

1. **Валидация данных** - все входные данные валидируются через Pydantic
2. **Типизация** - строгая типизация на всех уровнях
3. **Логирование** - структурированное логирование всех операций
4. **Обработка ошибок** - централизованная обработка исключений
5. **Кеширование** - кеширование настроек для производительности

### Защита чувствительных данных

- Access Token отображается как password field
- Возможность скрыть/показать токен
- Валидация токена через тест подключения к VK API

## 🚀 Производительность

### Оптимизации

1. **Кеширование настроек** - TTL 5 минут на backend
2. **React Query кеширование** - 5 минут на frontend
3. **Lazy loading** - компоненты загружаются по требованию
4. **Suspense** - плавные загрузочные состояния
5. **Debounced updates** - предотвращение частых API вызовов

### Мониторинг

- Health checks для всех компонентов системы
- Метрики производительности
- Логирование операций с настройками

## 🔄 Расширяемость

### Добавление новых настроек

#### Backend

1. Добавить новое поле в соответствующую Pydantic модель
2. Обновить `SettingsService` для обработки нового поля
3. Добавить валидацию в `_validate_settings`
4. Обновить `_apply_settings` для применения настроек

#### Frontend

1. Добавить тип в `frontend/types/settings.ts`
2. Создать UI компонент для новой настройки
3. Добавить валидацию в `SETTINGS_VALIDATION`
4. Обновить соответствующий таб настроек

### Пример добавления новой настройки

```typescript
// frontend/types/settings.ts
interface VKAPISettings {
  access_token: string;
  api_version: string;
  requests_per_second: number;
  timeout_seconds: number; // Новая настройка
}

export const SETTINGS_VALIDATION = {
  vk_api: {
    requests_per_second: { min: 1, max: 20 },
    timeout_seconds: { min: 5, max: 60 }, // Валидация
  },
  // ...
};
```

```python
# backend/app/api/v1/settings.py
class VKAPISettings(BaseModel):
    access_token: str = Field(..., description="VK Access Token")
    api_version: str = Field(default="5.131", description="Версия VK API")
    requests_per_second: int = Field(default=3, ge=1, le=20)
    timeout_seconds: int = Field(default=30, ge=5, le=60) # Новая настройка
```

## 📈 Мониторинг и логирование

### Структурированное логирование

```python
logger.info("settings_updated",
    user_id="system",
    sections=["vk_api", "monitoring"],
    changes_count=2
)
```

### Health checks

- Проверка подключения к базе данных
- Проверка подключения к Redis
- Проверка доступности VK API
- Валидация настроек

### Метрики

- Время загрузки настроек
- Частота обновлений
- Количество ошибок валидации
- Статус компонентов системы

## 🎯 Лучшие практики

### Backend

1. **Используйте Pydantic для валидации** - автоматическая валидация типов и ограничений
2. **Кешируйте настройки** - уменьшение нагрузки на систему
3. **Логируйте изменения** - аудит операций с настройками
4. **Обрабатывайте ошибки** - graceful degradation при проблемах
5. **Тестируйте API** - unit и integration тесты

### Frontend

1. **Используйте TypeScript** - типобезопасность и лучший DX
2. **React Query для кеширования** - автоматическая синхронизация данных
3. **Валидация форм** - предотвращение отправки невалидных данных
4. **Loading states** - улучшение UX при загрузке
5. **Error boundaries** - обработка ошибок на уровне компонентов

### Общие принципы

1. **Принцип единственной ответственности** - каждый компонент отвечает за одну задачу
2. **DRY (Don't Repeat Yourself)** - переиспользование кода
3. **KISS (Keep It Simple, Stupid)** - простота и понятность
4. **Fail Fast** - раннее обнаружение ошибок
5. **Graceful Degradation** - работа при частичных сбоях

## 🔮 Будущие улучшения

### Планируемые функции

1. **Версионирование настроек** - история изменений
2. **Экспорт/импорт настроек** - резервное копирование
3. **Шаблоны настроек** - предустановленные конфигурации
4. **Уведомления об изменениях** - оповещение о критических изменениях
5. **A/B тестирование** - тестирование разных конфигураций

### Технические улучшения

1. **WebSocket для real-time обновлений** - мгновенная синхронизация
2. **Differential updates** - отправка только измененных полей
3. **Offline support** - работа без интернета
4. **Progressive Web App** - установка как нативное приложение
5. **Performance monitoring** - детальная аналитика производительности
