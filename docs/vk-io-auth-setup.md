# Настройка авторизации VK-IO

Документ описывает настройку авторизации для библиотеки vk-io, которая решает проблему IP-блокировки VK API.

## Поддерживаемые методы авторизации

### Метод 1: Использование существующего токена (рекомендуемый для production)

Самый простой и безопасный способ - использование готового токена VK API.

**Настройка:**

```env
# В файле .env
VK_ACCESS_TOKEN=ваш_токен_vk_api
```

**Преимущества:**
- Быстрая настройка
- Безопасность (не нужно хранить логин/пароль)
- Стабильная работа

**Недостатки:**
- Токен может истечь
- Ограничения по IP (решается через vk-io)

### Метод 2: DirectAuthorization (для разработки)

Автоматическое получение токена через логин/пароль с использованием официальных приложений VK.

**Настройка:**

```env
# В файле .env (только для разработки!)
VK_LOGIN=ваш_логин_vk
VK_PASSWORD=ваш_пароль_vk
```

**Преимущества:**
- Автоматическое обновление токенов
- Решение проблемы IP-блокировки
- Доступ ко всем API методам

**Недостатки:**
- Небезопасно хранить пароль в файле
- Может потребовать двухфакторную аутентификацию
- Только для разработки

## Логика выбора авторизации в vkIoService

VkIoService автоматически выбирает метод авторизации:

1. **Сначала пробует существующий токен** (`VK_ACCESS_TOKEN`)
   - Проверяет валидность через `account.getInfo`
   - Если токен работает - использует его

2. **Если токен не работает, переходит к DirectAuthorization**
   - Требует `VK_LOGIN` и `VK_PASSWORD`
   - Использует официальное Android приложение VK
   - Получает новый токен автоматически

3. **Если ничего не настроено - выдает ошибку**

## Решение проблемы IP-блокировки

### Проблема
```
"access_token was given to another ip address"
```

### Решение через vk-io
Библиотека vk-io автоматически решает эту проблему:

1. **Встроенный rate limiting** - предотвращает превышение лимитов
2. **Правильная обработка токенов** - корректная работа с различными типами токенов
3. **Автоматический retry** - повторные попытки при временных ошибках
4. **DirectAuthorization** - обход ограничений через официальные приложения

## Настройка для разных окружений

### Development
```env
# Можно использовать DirectAuthorization
VK_LOGIN=ваш_логин
VK_PASSWORD=ваш_пароль

# Или токен
VK_ACCESS_TOKEN=ваш_токен
```

### Production
```env
# Только токен (безопасно)
VK_ACCESS_TOKEN=ваш_производственный_токен
```

### Docker
```env
# В docker-compose.yml или .env
VK_ACCESS_TOKEN=ваш_токен
```

## Получение токена VK API

### Для приложений
1. Создайте приложение в [VK Developers](https://dev.vk.com/)
2. Получите `client_id` и `client_secret`
3. Используйте OAuth flow для получения токена

### Для пользователей
1. Перейдите в [VK Developers](https://dev.vk.com/)
2. Создайте standalone приложение
3. Получите токен через implicit flow

## Мониторинг и отладка

### Логи авторизации
VkIoService записывает подробные логи:

```typescript
// Успешная авторизация
logger.info('VK-IO успешно инициализирован с существующим токеном');

// Переход к DirectAuthorization
logger.warn('Существующий токен недействителен, переходим к DirectAuthorization');

// Ошибки авторизации
logger.error('Ошибка инициализации VK-IO');
```

### Проверка статуса
```typescript
// Проверка инициализации
const stats = vkIoService.getServiceStats();
console.log('Инициализирован:', stats.isInitialized);

// Проверка токена
const isValid = await vkIoService.validateToken();
console.log('Токен валиден:', isValid);
```

## Troubleshooting

### Ошибка: "Не найдены учетные данные для VK API"
**Решение:** Добавьте `VK_ACCESS_TOKEN` или `VK_LOGIN`/`VK_PASSWORD` в `.env`

### Ошибка: "access_token was given to another ip address"
**Решение:** Используйте vk-io - эта ошибка должна исчезнуть автоматически

### Ошибка авторизации через DirectAuthorization
**Возможные причины:**
- Включена двухфакторная аутентификация
- Неправильный логин/пароль
- VK заблокировал доступ

**Решение:** Используйте готовый токен вместо DirectAuthorization

### Проблемы с rate limiting
**Решение:** vk-io автоматически управляет лимитами, дополнительная настройка не требуется

## Безопасность

### Рекомендации
1. **Никогда не коммитьте** `.env` файлы с паролями в репозиторий
2. **Используйте переменные окружения** в production
3. **Ротируйте токены** регулярно
4. **Ограничивайте права токенов** только необходимыми scope

### Защита токенов
```bash
# Правильно
export VK_ACCESS_TOKEN="your_token"

# Неправильно
echo "VK_ACCESS_TOKEN=your_token" >> .env
git add .env  # НЕ ДЕЛАЙТЕ ТАК!
```

## Примеры кода

### Инициализация с проверкой
```typescript
import vkIoService from '@/services/vkIoService';

// Проверка перед использованием
try {
  const isValid = await vkIoService.validateToken();
  if (isValid) {
    console.log('VK API готов к использованию');
  } else {
    console.error('Проблемы с авторизацией VK API');
  }
} catch (error) {
  console.error('Ошибка инициализации VK API:', error);
}
```

### Получение статистики
```typescript
const stats = vkIoService.getServiceStats();
console.log('Статус VK-IO:', {
  инициализирован: stats.isInitialized,
  версияAPI: stats.apiVersion,
  возможности: stats.features
});
```

### Принудительная переинициализация
```typescript
// При смене токенов
await vkIoService.reinitialize();
```