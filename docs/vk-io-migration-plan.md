# План миграции с нашего хардкорного VK API на vk-io

На основе изучения документации vk-io, составляю подробный план миграции, который решит наши проблемы с IP-блокировкой и упростит работу с VK API.

## Преимущества vk-io

1. **Решает проблему IP-блокировки** - библиотека правильно работает с различными типами токенов
2. **Встроенный rate limiting** - автоматическое управление лимитами запросов
3. **TypeScript support** - полная типизация для нашего TS проекта
4. **Продвинутые возможности авторизации** - поддержка DirectAuthorization и Client Credentials
5. **1:1 mapping с VK API** - все методы доступны как `vk.api.methodName()`
6. **Встроенная обработка ошибок** - автоматический retry и правильная обработка ошибок VK API

## План миграции

### Этап 1: Установка и настройка vk-io
```bash
cd backend/
npm install vk-io @vk-io/authorization
```

### Этап 2: Создание нового VK API сервиса
**Файл**: `backend/src/services/vkIoService.ts`
- Инициализация VK instance с токеном
- Реализация основных методов (getGroups, getPosts, getComments)
- Добавление обработки ошибок и логирования
- Совместимость с существующими интерфейсами

### Этап 3: Обновление интерфейсов и типов
**Файлы**: `backend/src/types/vk.ts`, `backend/src/repositories/vkApi.ts`
- Адаптация существующих интерфейсов под vk-io
- Сохранение совместимости с текущим кодом
- Добавление новых типов для расширенной функциональности

### Этап 4: Обновление очередей и воркеров
**Файлы**:
- `backend/src/services/queueService.ts`
- `backend/src/workers/vkCollectWorker.ts`
- Замена вызовов старого API на новый vkIoService
- Обновление обработки ошибок и progress tracking

### Этап 5: Тестирование и валидация
- Создание юнит-тестов для vkIoService
- Интеграционные тесты с реальными VK данными
- Проверка совместимости с существующими задачами

### Этап 6: Авторизация (решение IP проблемы)
**Варианты реализации**:

**Вариант A: DirectAuthorization (рекомендуемый)**
```typescript
import { VK } from 'vk-io';
import { DirectAuthorization, officialAppCredentials } from '@vk-io/authorization';

const direct = new DirectAuthorization({
    scope: 'all',
    ...officialAppCredentials.android,
    login: process.env.VK_LOGIN,
    password: process.env.VK_PASSWORD,
    apiVersion: '5.199'
});

const { token } = await direct.run();
const vk = new VK({ token });
```

**Вариант B: Использование существующего токена**
```typescript
import { VK } from 'vk-io';

const vk = new VK({
    token: process.env.VK_ACCESS_TOKEN,
    apiVersion: '5.199'
});
```

### Этап 7: Рефакторинг существующего кода
**Файлы для обновления**:
- `backend/src/repositories/vkApi.ts` - замена на vkIoService
- `backend/src/services/vkService.ts` - обновление методов
- `backend/src/controllers/taskController.ts` - адаптация под новый API

### Этап 8: Удалить старый API
- Удалить всю старую реализацию после перехода

## Структура файлов после миграции

```
backend/src/
├── services/
│   ├── vkIoService.ts          # Новый VK API сервис
│   ├── vkService.ts            # Обновленный основной сервис
│   └── queueService.ts         # Обновленные очереди
├── repositories/
│   ├── vkApi.ts               # Deprecated (постепенное удаление)
│   └── vkIoApi.ts             # Новая реализация
├── types/
│   ├── vk.ts                  # Обновленные типы
│   └── vkIo.ts               # Новые типы для vk-io
└── workers/
    └── vkCollectWorker.ts     # Обновленный воркер
```

## Преимущества после миграции

1. **Решение IP проблемы** - корректная работа с серверного IP
2. **Автоматический rate limiting** - нет необходимости в собственной реализации
3. **Улучшенная надежность** - встроенная обработка ошибок и retry
4. **Лучшая производительность** - оптимизированные запросы к VK API
5. **Упрощенная поддержка** - меньше кастомного кода для поддержки
6. **TypeScript совместимость** - полная типизация из коробки

## Риски и митигация

**Риски**:
- Изменение поведения API вызовов
- Возможные breaking changes в структуре ответов
- Необходимость тестирования всех сценариев

**Митигация**:
- Поэтапная миграция с feature flags
- Комплексное тестирование на staging
- Возможность быстрого rollback к старой реализации
- Сохранение обратной совместимости интерфейсов

## Текущие проблемы, которые решит миграция

### Проблема 1: IP-блокировка VK API
**Текущая ошибка**: `"access_token was given to another ip address"`
**Решение**: vk-io правильно работает с различными типами токенов и решает проблемы авторизации

### Проблема 2: Rate limiting
**Текущая проблема**: Ручная реализация rate limiting с RateLimiterMemory
**Решение**: Встроенный rate limiting в vk-io

### Проблема 3: Обработка ошибок VK API
**Текущая проблема**: Кастомная обработка ошибок и retry logic
**Решение**: Автоматическая обработка ошибок и retry в vk-io

### Проблема 4: Поддержка и обновления
**Текущая проблема**: Поддержка кастомного API wrapper
**Решение**: Использование популярной, поддерживаемой библиотеки

## Следующие шаги

1. **Получить разрешение на миграцию**
2. **Установить vk-io и зависимости**
3. **Создать прототип vkIoService**
4. **Протестировать авторизацию**
5. **Постепенно мигрировать функциональность**

Этот план позволит нам решить текущие проблемы с VK API и создать более надежную и поддерживаемую систему.