# Модуль Comments

Модуль для работы с комментариями VK, построенный по принципам чистой архитектуры и лучшим практикам FastAPI.

## Архитектура

### Слои приложения

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │     Router      │  │    Handlers     │  │  Schemas    │ │
│  │   (FastAPI)     │  │  (Business)     │  │ (Pydantic)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │    Service      │  │    Mappers      │  │Exceptions   │ │
│  │  (Business)     │  │ (Data Transform)│  │ (Error)     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Interfaces    │  │    Models       │  │  Constants  │ │
│  │ (Abstractions)  │  │   (Entities)    │  │   (Config)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │  Repository     │  │   Dependencies  │  │   Utils     │ │
│  │  (Data Access)  │  │  (DI Container) │  │ (Helpers)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Структура файлов

```
comments/
├── __init__.py          # Экспорты модуля
├── README.md           # Документация
├── router.py           # FastAPI роутер
├── handlers.py         # Обработчики HTTP запросов
├── service.py          # Бизнес-логика
├── repository.py       # Доступ к данным
├── interfaces.py       # Абстракции и протоколы
├── schemas.py          # Pydantic модели
├── mappers.py          # Преобразование данных
├── exceptions.py       # Специфичные исключения
├── dependencies.py     # FastAPI зависимости
├── models.py           # Базовые модели
├── config.py           # Конфигурация
├── constants.py        # Константы
└── utils.py           # Утилиты
```

## Принципы архитектуры

### 1. Разделение ответственности (SRP)

- **Router**: Только маршрутизация HTTP запросов
- **Handlers**: Обработка HTTP запросов и валидация
- **Service**: Бизнес-логика и координация
- **Repository**: Доступ к данным
- **Mappers**: Преобразование между слоями

### 2. Инверсия зависимостей (DIP)

- Все слои зависят от абстракций (интерфейсов)
- Конкретные реализации инжектируются через DI
- Легкое тестирование с моками

### 3. Принцип открытости/закрытости (OCP)

- Легко добавлять новые типы обработчиков
- Расширение функциональности без изменения существующего кода

### 4. Единый интерфейс (ISP)

- Интерфейсы разделены по функциональности
- Клиенты зависят только от нужных им методов

## Компоненты

### Router (`router.py`)

- Определяет HTTP эндпоинты
- Валидирует входные параметры
- Делегирует обработку в Handlers

### Handlers (`handlers.py`)

- Обрабатывает HTTP запросы
- Преобразует исключения в HTTP ответы
- Координирует работу сервисов

### Service (`service.py`)

- Содержит бизнес-логику
- Управляет кешированием
- Координирует работу репозитория

### Repository (`repository.py`)

- Абстракция доступа к данным
- Инкапсулирует SQL запросы
- Управляет транзакциями

### Interfaces (`interfaces.py`)

- Определяет контракты между слоями
- Обеспечивает тестируемость
- Позволяет легко менять реализации

### Mappers (`mappers.py`)

- Преобразует данные между слоями
- Изолирует логику маппинга
- Обеспечивает консистентность

### Exceptions (`exceptions.py`)

- Специфичные исключения модуля
- Централизованная обработка ошибок
- Структурированные HTTP ответы

## Преимущества новой архитектуры

### 1. Масштабируемость

- Легко добавлять новые функции
- Независимые компоненты
- Горизонтальное масштабирование

### 2. Тестируемость

- Все зависимости инжектируются
- Легко создавать моки
- Изолированное тестирование слоев

### 3. Поддерживаемость

- Четкое разделение ответственности
- Легко понимать и изменять код
- Минимальные побочные эффекты

### 4. Производительность

- Кеширование на уровне сервиса
- Оптимизированные запросы к БД
- Асинхронная обработка

### 5. Безопасность

- Валидация на всех уровнях
- Централизованная обработка ошибок
- Типобезопасность

## Использование

### Базовое использование

```python
from comments import router, CommentService, CommentRepository

# Регистрация роутера
app.include_router(router, prefix="/api/v1")

# Создание сервиса
service = CommentService(repository)
```

### Тестирование

```python
from comments.interfaces import CommentServiceInterface
from comments.service import CommentService

# Мок репозитория
class MockRepository(CommentServiceInterface):
    async def get_comment(self, comment_id: int):
        return {"id": comment_id, "text": "Test"}

# Тест сервиса
service = CommentService(MockRepository())
result = await service.get_comment(1)
```

## Конфигурация

### Переменные окружения

```env
# Кеширование
REDIS_URL=redis://localhost:6379
CACHE_TTL=300

# Логирование
LOG_LEVEL=INFO
LOG_FORMAT=json
```

### Настройка зависимостей

```python
# В dependencies.py
async def get_cache_service():
    return RedisCacheService()

async def get_logger():
    return get_loguru_logger("comments")
```

## Мониторинг и логирование

- Структурированное логирование
- Метрики производительности
- Трассировка запросов
- Централизованная обработка ошибок

## Миграция

Для миграции с старой архитектуры:

1. Обновите импорты в существующем коде
2. Замените прямые вызовы сервиса на handlers
3. Обновите обработку ошибок
4. Добавьте тесты для новых компонентов

## Дальнейшее развитие

- Добавление кеширования на уровне репозитория
- Реализация паттерна CQRS
- Добавление событийной модели
- Интеграция с системами мониторинга
