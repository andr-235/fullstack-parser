generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DB_URL")
  extensions = [pg_trgm]
}

model comments {
  id                            Int      @id @default(autoincrement())
  vk_comment_id                 Int      @unique
  post_vk_id                    Int
  owner_id                      Int
  author_id                     Int
  author_name                   String   @db.VarChar(255)
  text                          String   @default("")
  date                          DateTime
  likes                         Int      @default(0)
  userId                        Int?
  postId                        Int?
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime
  post_id                       Int?
  posts_comments_post_idToposts posts?   @relation("comments_post_idToposts", fields: [post_id], references: [id], onDelete: Cascade)

  @@index([author_id], map: "idx_comment_author")
  @@index([date], map: "idx_comment_date")
  @@index([postId], map: "idx_comment_legacy_post")
  @@index([likes], map: "idx_comment_likes")
  @@index([owner_id], map: "idx_comment_owner")
  @@index([post_id], map: "idx_comment_post")
  @@index([post_vk_id], map: "idx_comment_post_vk")
  @@index([vk_comment_id], map: "idx_comment_vk_id")
}

model groups {
  id           Int         @id @default(autoincrement())
  vkId         Int         @unique @map("vk_id") // VK ID группы (положительный)
  name         String?     // Название группы
  screenName   String?     @map("screen_name") // Короткое имя (ссылка)
  photo50      String?     @map("photo_50") // URL аватара 50x50
  membersCount Int?        @map("members_count") // Количество участников
  isClosed     Int         @default(0) @map("is_closed") // 0=открытая, 1=закрытая, 2=частная
  description  String?     // Описание группы
  taskId       String      @map("task_id") @db.Uuid
  uploadedAt   DateTime    @default(now()) @map("uploaded_at")
  status       GroupStatus @default(valid)

  @@index([vkId], map: "idx_group_vk_id")
  @@index([name], map: "idx_group_name")
  @@index([screenName], map: "idx_group_screen_name")
  @@index([status], map: "idx_group_status")
  @@index([taskId], map: "idx_group_task")
  @@index([uploadedAt], map: "idx_group_uploaded")
}

model posts {
  id                               Int        @id @default(autoincrement())
  vk_post_id                       Int        @unique
  owner_id                         Int
  group_id                         Int
  text                             String     @default("")
  date                             DateTime
  likes                            Int        @default(0)
  ownerId                          Int?
  groupId                          Int?
  createdAt                        DateTime   @default(now())
  updatedAt                        DateTime
  task_id                          Int
  comments_comments_post_idToposts comments[] @relation("comments_post_idToposts")
  tasks                            tasks      @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@index([date], map: "idx_post_date")
  @@index([group_id], map: "idx_post_group")
  @@index([likes], map: "idx_post_likes")
  @@index([owner_id], map: "idx_post_owner")
  @@index([task_id], map: "idx_post_task")
  @@index([vk_post_id], map: "idx_post_vk_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model tasks {
  id            Int        @id @default(autoincrement())
  priority      Int        @default(0) @db.SmallInt
  progress      Int        @default(0) @db.SmallInt
  groups        Json?
  metrics       Json?
  parameters    Json?
  result        Json?
  error         String?
  executionTime Int?
  startedAt     DateTime?
  finishedAt    DateTime?
  createdBy     String     @default("system") @db.VarChar(100)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime
  status        TaskStatus @default(pending)
  type          TaskType   @default(fetch_comments)
  posts         posts[]

  @@index([createdAt], map: "tasks_created_at")
  @@index([status])
  @@index([status, priority])
  @@index([type])
  @@index([type, status])
}

enum GroupStatus {
  valid
  invalid
  duplicate
}

enum TaskStatus {
  pending
  processing
  completed
  failed
}

enum TaskType {
  fetch_comments
  process_groups
  analyze_posts
}
