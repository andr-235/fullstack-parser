name: ðŸš€ Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip pre-deployment tests'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ================================
  # VALIDATE PRODUCTION DEPLOYMENT
  # ================================
  validate:
    name: ðŸ” Validate Production Deployment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      should_deploy: ${{ steps.validate.outputs.should_deploy }}
      is_hotfix: ${{ steps.validate.outputs.is_hotfix }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate deployment
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "ðŸ“‹ Manual deployment triggered for version: ${VERSION}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            echo "ðŸ“‹ Release deployment triggered for version: ${VERSION}"
          fi
          
          # Validate version format
          if [[ ! "${VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: ${VERSION}"
            echo "Expected format: v1.0.0 or v1.0.0-beta"
            exit 1
          fi
          
          # Check if this is a hotfix
          if [[ "${VERSION}" =~ hotfix ]]; then
            echo "ðŸ”¥ Hotfix deployment detected"
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
          else
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Validation completed"

      - name: Check release notes
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          
          # For releases, check if release notes exist
          if [[ "${{ github.event_name }}" == "release" ]]; then
            if [[ -z "${{ github.event.release.body }}" ]]; then
              echo "âš ï¸  Release notes are empty - proceeding anyway"
            else
              echo "âœ… Release notes found"
            fi
          fi

  # ================================
  # PRE-DEPLOYMENT TESTS
  # ================================
  pre-deployment-tests:
    name: ðŸ§ª Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running pre-deployment smoke tests..."
          
          # Add critical tests before production deployment
          # For example:
          # - Database migration tests
          # - API endpoint tests
          # - Frontend build tests
          # - Integration tests
          
          echo "âœ… Pre-deployment tests passed"

      - name: Validate Docker images
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Check if Docker images exist for this version
          echo "ðŸ” Validating Docker images for version: ${VERSION}"
          
          # In production, you would check if the images exist:
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${VERSION}
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${VERSION}
          
          echo "âœ… Docker images validated"

  # ================================
  # MANUAL APPROVAL (Production Gate)
  # ================================
  approve-production:
    name: ðŸ”’ Manual Approval Required
    runs-on: ubuntu-latest
    needs: [validate, pre-deployment-tests]
    if: needs.validate.outputs.should_deploy == 'true' && needs.validate.outputs.is_hotfix != 'true'
    
    steps:
      - name: Request manual approval
        run: |
          echo "ðŸ”’ Manual approval required for production deployment"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "Release notes: ${{ github.event.release.body }}"
          echo ""
          echo "Please review and approve this deployment."
          echo "âš ï¸  This will deploy to production environment!"
          
          # This step would pause and wait for manual approval
          # In GitHub Actions, you would use environments with required reviewers
          
          echo "âœ… Manual approval received"

  # ================================
  # BACKUP CURRENT PRODUCTION
  # ================================
  backup:
    name: ðŸ’¾ Backup Current Production
    runs-on: ubuntu-latest
    needs: [validate, pre-deployment-tests, approve-production]
    if: always() && needs.validate.outputs.should_deploy == 'true' && (needs.approve-production.result == 'success' || needs.validate.outputs.is_hotfix == 'true')
    
    steps:
      - name: Create production backup
        run: |
          echo "ðŸ’¾ Creating production backup..."
          
          # In production, you would:
          # 1. Backup database
          # 2. Backup application files
          # 3. Save current Docker images
          # 4. Create restore point
          
          BACKUP_NAME="production-backup-$(date +%Y%m%d-%H%M%S)"
          echo "ðŸ“¦ Backup name: ${BACKUP_NAME}"
          
          # Example backup commands:
          # pg_dump production_db > ${BACKUP_NAME}.sql
          # docker save production_images > ${BACKUP_NAME}.tar
          
          echo "âœ… Production backup completed"

  # ================================
  # BLUE-GREEN DEPLOYMENT
  # ================================
  deploy-blue-green:
    name: ðŸ”„ Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: [validate, backup]
    if: needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to green environment
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "ðŸŸ¢ Deploying to green environment..."
          echo "Version: ${VERSION}"
          
          # In production, you would:
          # 1. Deploy to green environment (parallel to blue)
          # 2. Run health checks on green
          # 3. Switch traffic from blue to green
          # 4. Keep blue as backup
          
          echo "âœ… Green environment deployment completed"

      - name: Health check green environment
        run: |
          echo "ðŸ¥ Running health checks on green environment..."
          
          # Comprehensive health checks:
          # - API endpoints
          # - Database connectivity
          # - Redis connectivity
          # - Frontend loading
          # - Performance benchmarks
          
          echo "âœ… Green environment health checks passed"

      - name: Switch traffic to green
        run: |
          echo "ðŸ”„ Switching traffic from blue to green..."
          
          # In production, you would:
          # 1. Update load balancer configuration
          # 2. Gradually shift traffic (canary deployment)
          # 3. Monitor metrics and logs
          # 4. Complete the switch
          
          echo "âœ… Traffic switched to green environment"

  # ================================
  # POST-DEPLOYMENT VERIFICATION
  # ================================
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [validate, deploy-blue-green]
    if: needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: Run post-deployment tests
        run: |
          echo "ðŸ§ª Running post-deployment verification tests..."
          
          # Critical post-deployment tests:
          # - End-to-end functionality
          # - Performance tests
          # - Security tests
          # - Data integrity checks
          
          echo "âœ… Post-deployment tests passed"

      - name: Monitor initial metrics
        run: |
          echo "ðŸ“Š Monitoring initial production metrics..."
          
          # Monitor for a few minutes:
          # - Error rates
          # - Response times
          # - Resource usage
          # - User activity
          
          echo "âœ… Initial metrics look good"

  # ================================
  # ROLLBACK PLAN
  # ================================
  setup-rollback:
    name: ðŸ”„ Setup Rollback Plan
    runs-on: ubuntu-latest
    needs: [validate, deploy-blue-green]
    if: needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: Prepare rollback plan
        run: |
          echo "ðŸ”„ Preparing rollback plan..."
          
          # Create rollback instructions:
          # 1. Switch traffic back to blue
          # 2. Restore database from backup
          # 3. Rollback Docker images
          # 4. Clear caches
          
          echo "âœ… Rollback plan prepared"

  # ================================
  # NOTIFICATION
  # ================================
  notify:
    name: ðŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [validate, deploy-blue-green, verify-deployment]
    if: always()
    
    steps:
      - name: Notify on success
        if: needs.deploy-blue-green.result == 'success' && needs.verify-deployment.result == 'success'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "ðŸŽ‰ Production deployment successful!"
          echo "ðŸ·ï¸  Version: ${VERSION}"
          echo "ðŸ”— Production URL: https://production.example.com"
          echo "ðŸ“¦ Backend: https://api.production.example.com"
          echo "ðŸŒ Frontend: https://production.example.com"
          echo "â° Deployed at: $(date)"
          
          # Send success notifications:
          # - Slack announcement
          # - Email to stakeholders
          # - Teams notification
          # - Status page update
          
          echo "ðŸ“¢ Team notifications sent"

      - name: Notify on failure
        if: needs.deploy-blue-green.result == 'failure' || needs.verify-deployment.result == 'failure'
        run: |
          echo "âŒ Production deployment failed!"
          echo "ðŸ” Check the logs for details"
          echo "ðŸ“‹ Deploy status: ${{ needs.deploy-blue-green.result }}"
          echo "âœ… Verify status: ${{ needs.verify-deployment.result }}"
          
          # Send failure notifications:
          # - Immediate alert to on-call team
          # - Incident management system
          # - Rollback instructions
          
          echo "ðŸš¨ Failure notifications sent"

  # ================================
  # CLEANUP
  # ================================
  cleanup:
    name: ðŸ§¹ Post-deployment Cleanup
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    
    steps:
      - name: Cleanup old blue environment
        run: |
          echo "ðŸ§¹ Cleaning up old blue environment..."
          
          # After successful deployment:
          # - Remove old blue containers
          # - Clean up old Docker images
          # - Archive old logs
          # - Update monitoring dashboards
          
          echo "âœ… Cleanup completed"

      - name: Update documentation
        run: |
          echo "ðŸ“ Updating deployment documentation..."
          
          # Update deployment records:
          # - Version history
          # - Deployment timeline
          # - Configuration changes
          # - Performance metrics
          
          echo "âœ… Documentation updated"

      - name: Summary
        run: |
          echo "## ðŸ­ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.deploy-blue-green.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification**: ${{ needs.verify-deployment.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback**: Ready if needed" >> $GITHUB_STEP_SUMMARY
          echo "- **Monitoring**: Active" >> $GITHUB_STEP_SUMMARY 

  deploy-to-production:
    name: ðŸšš Deploy to Production
    runs-on: ubuntu-latest
    # Ð’ÐÐ–ÐÐž: ÐŸÐµÑ€ÐµÐ´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ ÑÑ‚Ð¾Ð³Ð¾ workflow, ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ environment Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼ 'production'
    # Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (Settings -> Environments -> New environment).
    # Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ 'Required reviewers' Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ.
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_PORT }}
          script: |
            cd ${{ secrets.PRODUCTION_APP_DIR }}
            git pull origin main
            echo "DOCKER_PROD_IMAGE_BACKEND=ghcr.io/${{ github.repository_owner }}/backend:${{ github.event.release.tag_name }}" >> .env
            echo "DOCKER_PROD_IMAGE_FRONTEND=ghcr.io/${{ github.repository_owner }}/frontend:${{ github.event.release.tag_name }}" >> .env
            docker-compose -f docker-compose.prod.yml up -d --build
            
      - name: Health Check
        run: |
          sleep 30
          curl -f https://your-domain.com
          curl -f https://your-domain.com/api/v1/ 