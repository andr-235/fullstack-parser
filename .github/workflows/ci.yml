name: ğŸ”„ Continuous Integration

on:
  push:
    branches: 
      - main
      - develop
      - 'feature/*'
      - 'fix/*'
      - 'hotfix/*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  PYTHON_VERSION_DEFAULT: '3.11'
  NODE_VERSION_DEFAULT: '20'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'pyproject.toml'
            frontend:
              - 'frontend/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            docker:
              - '**/Dockerfile'
              - 'docker-compose.yml'

  backend-test:
    name: ğŸ Backend Tests
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    uses: ./.github/workflows/reusable-backend-test.yml

  frontend-test:
    name: âš›ï¸ Frontend Tests
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    uses: ./.github/workflows/reusable-frontend-test.yml

  docker-test:
    name: ğŸ³ Docker Build Test
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: false
          tags: ${{ matrix.service }}:test

  integration-test:
    name: ğŸ”— Integration Test
    needs: [backend-test, frontend-test]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start services
        run: |
          cp env.example .env
          docker-compose up -d --build
      - name: Wait for services
        run: sleep 30 && curl -f http://localhost:8000/api/v1/health && curl -f http://localhost:3000
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  quality-gate:
    name: ğŸ¯ Quality Gate
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, docker-test]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          if [[ "${{ needs.backend-test.result }}" == "failure" || "${{ needs.frontend-test.result }}" == "failure" || "${{ needs.docker-test.result }}" == "failure" ]]; then
            echo "âŒ Quality gate failed due to test failures."
            exit 1
          else
            echo "âœ… Quality gate passed."
          fi

  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [quality-gate, integration-test]
    if: always() && needs.quality-gate.result == 'success' && (needs.integration-test.result == 'success' || needs.integration-test.result == 'skipped')
    steps:
      - name: Report success
        run: echo "ğŸ‰ All CI checks passed successfully!" 