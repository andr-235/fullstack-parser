name: ğŸ·ï¸ Create Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: ğŸ—ï¸ Build Release
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Ğ›Ğ¾Ğ³Ğ¸Ğ½ Ğ² GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿ÑƒÑˆ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
        run: |
          # Backend
          docker build -t ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }} ./backend
          docker push ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}

          # Frontend
          docker build -t ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }} ./frontend
          docker push ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}

      - name: ğŸ“ Generate changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              head: context.sha
            });

            const changelog = commits.commits
              .map(commit => `- ${commit.commit.message}`)
              .join('\n');

            return changelog;

      - name: ğŸ·ï¸ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ğŸš€ What's New

            ${{ steps.changelog.outputs.result }}

            ## ğŸ“¦ Docker Images

            - Backend: `ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}`
            - Frontend: `ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}`

            ## ğŸ”§ Installation

            ```bash
            docker pull ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}
            docker pull ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}
            ```
          draft: false
          prerelease: false
