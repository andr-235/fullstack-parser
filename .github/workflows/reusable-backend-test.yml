# Reusable Backend Tests Workflow
# Best practices: pin actions, timeouts, minimal permissions, concurrency, matrix, cache, upload coverage, DRY, comments

on:
  workflow_call:
    inputs:
      python-versions:
        description: 'Python versions to test against'
        required: false
        default: '["3.11", "3.12"]'
        type: string                                                                                            
      upload-coverage:
        description: 'Upload coverage to Codecov and as artifact'
        required: false
        default: '"true"'
        type: string
    secrets:
      CODECOV_TOKEN:
        required: false

concurrency:
  group: backend-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-lint:
    uses: ./.github/workflows/steps-lint.yml
    with:
      target: backend
      python-version: '3.11'
    secrets: inherit
    permissions:
      contents: read
    concurrency:
      group: backend-lint-${{ github.ref }}
      cancel-in-progress: true

  backend-test:
    needs: backend-lint
    uses: ./.github/workflows/steps-test.yml
    with:
      target: backend
      python-version: '3.11'
      upload-coverage: 'true'
    secrets: inherit 
    permissions:
      contents: read
    concurrency:
      group: backend-test-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false 