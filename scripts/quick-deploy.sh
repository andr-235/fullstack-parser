#!/bin/bash

# üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
set -e

echo "üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π –≤ production..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ main –≤–µ—Ç–∫–µ
if [[ $(git branch --show-current) != "main" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –∏–∑ main –≤–µ—Ç–∫–∏!"
    echo "–ü–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ main: git checkout main"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if [[ -n $(git status --porcelain) ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
    echo "–°–¥–µ–ª–∞–π –∫–æ–º–º–∏—Ç –∏–ª–∏ stash: git add . && git commit -m 'fix: –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è'"
    exit 1
fi

# –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
echo "üß™ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
cd backend && poetry run pytest tests/ -v --tb=short --maxfail=3 && cd ..
cd frontend && pnpm test --passWithNoTests --watchAll=false && cd ..
echo "‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!"

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
read -p "üöÄ –î–µ–ø–ª–æ–∏—Ç—å –≤ production? (y/N): " confirm
if [[ ! $confirm =~ ^[Yy]$ ]]; then
    echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω—ë–Ω"
    exit 0
fi

# –ü—É—à –≤ main (–∑–∞–ø—É—Å—Ç–∏—Ç CI/CD)
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git push origin main

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω!"
echo "üìä –°–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º: https://github.com/andr-235/fullstack/actions"
echo "üåê Production: https://192.168.88.12"

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
read -p "–ñ–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è? (y/N): " wait
if [[ $wait =~ ^[Yy]$ ]]; then
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è..."
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ GitHub API
    echo "‚úÖ –î–µ–ø–ª–æ–π –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç"
fi
