# Активный контекст: Рефакторинг Backend

**ID Задачи:** `REFACTOR-BACKEND-01`
**Статус:** `IMPLEMENTATION`

##  архитектурные решения (Creative Phase)

### 1. Система логирования (`structlog`)

- **Реализация:** `app/core/logging.py` и `app/middleware/request_logging.py`.
- **Концепция:**
  - Настроен `structlog` с JSON-рендерером для продакшена и цветным консольным выводом для разработки.
  - Создан `RequestLoggingMiddleware`, который автоматически логирует все HTTP-запросы.
  - Для каждого запроса генерируется `request_id`, который привязывается ко всем логам в рамках этого запроса для удобной трассировки.

### 2. Архитектура Pydantic-схем

- **Реализация:** Продемонстрировано на `app/schemas/vk_group.py`.
- **Концепция:** Введен строгий паттерн для разделения схем по их назначению:
  - `SchemaBase`: Общие поля.
  - `SchemaCreate`: Для создания записей.
  - `SchemaUpdate`: Для обновления (все поля опциональны).
  - `SchemaRead`: Для ответов API (данные, видимые клиенту).
  - `SchemaInDB`: Полное представление модели в БД.
- Все схемы наследуются от `schemas/base.py:BaseSchema`.

### 3. Дизайн сервисного слоя

- **Реализация:** `app/services/base.py` и `app/services/group_service.py`.
- **Концепция:**
  - **`BaseService`:** Создан generic-класс `BaseService`, реализующий базовые CRUD-операции. Это позволяет избежать дублирования кода.
  - **CRUD-сервисы:** Для каждой модели создается свой сервис (например, `GroupService`), который наследует `BaseService`.
  - **Композиция > Наследование:** Сложные сервисы (например, `ParserService`) не наследуют `BaseService`, а получают другие сервисы (`GroupService`, `VKAPIService` и т.д.) в качестве зависимостей через конструктор. Это обеспечивает слабую связанность и высокую тестируемость.
- **Принцип:** Сервисный слой полностью отделен от FastAPI. Он не работает с `Request`, `Depends` и другими элементами веб-фреймворка.
